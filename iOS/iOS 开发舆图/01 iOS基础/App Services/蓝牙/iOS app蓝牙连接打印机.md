---
title: iOS app蓝牙连接打印机
tags: 蓝牙
categories: 蓝牙
abbrlink: 18110
date: 2018-06-25 12:01:03
---

最近做了个app蓝牙连接打印机打印的功能，感觉这方面的东西网上的不多，所以写一篇文章存个档。

因为我本人也是第一次接触蓝牙方面的功能，所以一开始也是各种百度，最后找到了大神写好的一个蓝牙库，叫**BLEPrinter**。了解清楚其中原理之后，直接用上项目了。

首先第一步就是连接打印机了，这一步用了库的话实在没什么好说的了，根据实际需要调用一下库中方法就行，上图：

![3013207-7381e28e62e4dbab](https://gitee.com/coderiding/picbed/raw/master/uPic/3013207-7381e28e62e4dbab.png)

库中方法

好了，打印机连好了，那么，要打印的数据从哪里来？因为这个项目中已经集成好了极光，所以后台将通过极光自定义消息来发送订单编号。所以我在极光接收自定义消息的代理里加了个通知，然后再连接打印机的界面里写了接收通知和通知方法实现的代码，上代码：

![3013207-05593fc726d0fba4](https://gitee.com/coderiding/picbed/raw/master/uPic/3013207-05593fc726d0fba4.png)

appDelegate中



<!-- more -->

![3013207-a496849a16d3bd5f](https://gitee.com/coderiding/picbed/raw/master/uPic/3013207-a496849a16d3bd5f.png)

连接打印机的界面中

接着实现这个startPrintOrder:方法就可以了。打印数据的方法，库中已经提供了。由于我通过自定义消息拿到的只是订单号，所以还要通过请求一次接口拿到该订单的订单详情。拿到订单详情之后就需要排版打印数据了。看了一下库，排版所需的指令集已经封装好，可以根据自己的需求修改。顺便提一下，我的项目中，打印机具有切割的功能，所以需要切割的指令集，当时百度了很久都没找到，后来还是安卓给的我，为了方便他人，在这里放出：

![Xnip2020-11-06_14-14-05](https://gitee.com/coderiding/picbed/raw/master/uPic/Xnip2020-11-06_14-14-05.jpg)

切割指令集

调用打印方法，将排版好的数据打印出来：

![Xnip2020-11-06_14-14-23](https://gitee.com/coderiding/picbed/raw/master/uPic/Xnip2020-11-06_14-14-23.jpg)

库中方法

到了这里，打印功能就差不多完成了。测试一下，因为自定义消息的方法只能在app处于前台状态的时候使用，所以，成功连接打印机之后app在前台时，收到订单之后，可以马上打印出订单详情。当app处于后台时，收到订单之后不会马上打印出订单详情，而是等app重新回到前台状态，如果这个时候蓝牙打印机没有断开连接的话，就会打印出在后台收到的所有订单的订单详情。

ok，完事，去找产品提交任务。产品说：不行，**要求app在后台时收到订单也要打印，手机锁屏也要打印**。行吧，现在开始考虑后台打印。

------

和安卓，后台商量了下，决定app处于前台的时候，订单编号通过自定义消息发送；app处于后台的时候，订单编号通过通知的形式发送。那么问题来了，后台如何知道app是处在前台还是后台呢？调接口。

后台给了个接口，让我在前台的时候传个1，进入后台了，传个0，所以我在appDelegate里：

![Xnip2020-11-06_14-14-39](https://gitee.com/coderiding/picbed/raw/master/uPic/Xnip2020-11-06_14-14-39.jpg)

前台后台的代理

然后在极光接收通知消息内容的代理里加个通知：

![Xnip2020-11-06_14-15-10](https://gitee.com/coderiding/picbed/raw/master/uPic/Xnip2020-11-06_14-15-10.jpg)

appDelegate中

然后如同自定义消息一般在连接打印机的界面中实现对应的通知方法就可以了。流程现在已经很清晰了，然而。。。

因为蓝牙功能只能用真机测试，所以我通过xcode连着数据线在真机上运行程序，测完前台的功能之后，继续测试后台是否能打印。嗯，这个断点跑到了，那个方法走到了，结果完全没啥问题。所以我就把程序提交给了测试小姐姐去测。后来测试小姐姐反馈给我说：iOS前台打印可以，后台打印不行，安卓的都可以。

我？？？明明我自己测试的时候是没啥问题的。于是我又用xcode连线真机运行，该走的方法都走了，为什么测试那关过不去呢？后来我发现，真机独立运行程序，连上打印机后把app切换到后台或者直接锁屏，下单，收到通知，确实是不打印。但是真机独立运行的话报错信息我怎么看？于是我陷入了连着线运行没问题，真机独立运行有问题但是看不出问题的死循环中。。。

期间查看了不少蓝牙后台模式的文章，项目中支持蓝牙后台模式的key和mode都设置了，但是还是不行。后来有人劝我让用户点击通知回到app再打印，我试了试，这个方法不太符合需求，我发现点击通知回到app的时候其他的这个APP的通知都会消失，而我在那条通知里只能获取到那条通知所包含着的订单编号。假设在后台的时候收到了几条订单，然而我点击某一条通知只能打印出点击的那条通知的订单，别的订单都消失了，GG。也有人猜测是不是程序在后台被杀死了，于是我添加了百度来的在后台继续存活三分钟的代码，发现在三分钟里还是不打印。无奈啊无奈，用xcode调试后台打印，代码都运行的，一用真机独立测试就不行了，哪一步出了问题也看不出。

后来我跟几个iOS好友们讨论了许久，他们认为我要在后台，实现请求接口(拿到订单编号去请求订单数据)，排版打印数据，再发送打印指令让打印机打印(也是个异步过程)，是不太可能的，苹果手机不会允许一个在后台的app还能够做这么多事的。但是我蓝牙后台模式要求的配置都弄了啊，蓝牙的后台模式到底能做些什么东西？更重要的是为什么xcode连着线运行后台打印没问题？就是因为xcode连着线运行后台打印没问题，我才一直以为是我代码的问题。我觉得我很委屈。。。

折腾了半个月，实在没办法了，就把这个问题交给了上级。上级后来给了我答复。他查了资料发现，iOS端app后台蓝牙长久的与蓝牙设备连接，这个确实是可以实现的。但是需要这个蓝牙设备支持心跳机制，并且是蓝牙设备给app发消息，app给蓝牙设备发消息的话不好实现。行吧，最后结果是iOS端后台打印功能不做了，只支持前台。这个卡了我近月的坎终于过去了。

文末了，还有个问题还没解决：xcode连着线在真机上运行app，后台打印没问题的原因，可能是通过xcode运行，真机会给这个app提供足够多的内存吧，所以没问题。但是真机独立运行了，就不行了。

后来我就把程序改成了只有前台打印，对，也就是分割线之前的那个样子。之所以会写这篇文章，也希望如果有人遇到了和我一样的需求之后，这篇文章能够帮到你，至少别在后台打印那一块和我一样傻乎乎的折腾许久了吧，看着安卓能流畅的实现后台打印，我眼红啊。最后，如果我这篇文章中有什么错误，请告诉我；如果你已经实现了iOS后台打印，那就更要告诉我了，让我参考下你的实现方法。(长叹一口气)一起努力吧！